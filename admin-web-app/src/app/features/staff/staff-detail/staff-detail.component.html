<div class="space-y-6" *ngIf="!isLoading">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div class="flex items-center gap-4">
            <button (click)="goBack()" class="btn btn-secondary">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div>
                <h1 class="text-2xl font-bold text-gray-900">
                    {{ isNew ? 'Add New Staff' : (staff?.first_name + ' ' + staff?.last_name) }}
                </h1>
                <p class="text-gray-600">{{ isNew ? 'Create a new staff member' : 'Staff Details' }}</p>
            </div>
        </div>
    </div>

    <!-- Avatar Section -->
    <div class="card">
        <div class="flex flex-col items-center gap-4 py-6">
            <div class="relative">
                <div *ngIf="!photoPreview" 
                    class="w-32 h-32 bg-primary-100 rounded-full flex items-center justify-center text-primary-600 text-4xl font-bold">
                    {{ getInitials() }}
                </div>
                <img *ngIf="photoPreview" [src]="photoPreview" 
                    alt="Staff Photo" 
                    class="w-32 h-32 rounded-full object-cover border-4 border-primary-200">
                <label class="absolute bottom-0 right-0 bg-primary-600 text-white rounded-full p-2 cursor-pointer hover:bg-primary-700 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <input type="file" accept="image/*" (change)="onPhotoSelected($event)" class="hidden">
                </label>
            </div>
            <p class="text-sm text-gray-600">Click the camera icon to upload a photo</p>
        </div>
    </div>

    <!-- Separator -->
    <hr class="border-red-100">

    <!-- Tabs -->
    <div class="card">
        <div class="border-b border-gray-200">
            <nav class="flex overflow-x-auto -mb-px">
                <button
                    (click)="activeTab = 'profile'"
                    [class.border-primary-600]="activeTab === 'profile'"
                    [class.text-primary-600]="activeTab === 'profile'"
                    [class.border-transparent]="activeTab !== 'profile'"
                    [class.text-gray-500]="activeTab !== 'profile'"
                    class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm hover:text-gray-700 hover:border-gray-300">
                    Profile
                </button>
                <button
                    *ngIf="!isNew"
                    (click)="activeTab = 'performance'"
                    [class.border-primary-600]="activeTab === 'performance'"
                    [class.text-primary-600]="activeTab === 'performance'"
                    [class.border-transparent]="activeTab !== 'performance'"
                    [class.text-gray-500]="activeTab !== 'performance'"
                    class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm hover:text-gray-700 hover:border-gray-300">
                    Performance
                </button>
            </nav>
        </div>

        <!-- Profile Tab Content -->
        <div *ngIf="activeTab === 'profile'" class="p-6">
            <form [formGroup]="staffForm">
                <!-- Personal Information Section -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4 text-gray-900">Personal Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                            <input type="text" formControlName="first_name" class="input-field"
                                [class.border-red-500]="staffForm.get('first_name')?.invalid && staffForm.get('first_name')?.touched">
                            <p *ngIf="staffForm.get('first_name')?.invalid && staffForm.get('first_name')?.touched" 
                                class="text-red-500 text-xs mt-1">First name is required</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                            <input type="text" formControlName="last_name" class="input-field"
                                [class.border-red-500]="staffForm.get('last_name')?.invalid && staffForm.get('last_name')?.touched">
                            <p *ngIf="staffForm.get('last_name')?.invalid && staffForm.get('last_name')?.touched" 
                                class="text-red-500 text-xs mt-1">Last name is required</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                            <input type="date" formControlName="date_of_birth" class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sex</label>
                            <select formControlName="sex" class="input-field">
                                <option value="">Select...</option>
                                <option *ngFor="let option of sexOptions" [value]="option.value">{{ option.label }}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
                            <input type="tel" formControlName="phone_number" class="input-field"
                                [class.border-red-500]="staffForm.get('phone_number')?.invalid && staffForm.get('phone_number')?.touched">
                            <p *ngIf="staffForm.get('phone_number')?.invalid && staffForm.get('phone_number')?.touched" 
                                class="text-red-500 text-xs mt-1">Phone number is required</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" formControlName="email" class="input-field">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                            <textarea formControlName="address" rows="2" class="input-field"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">House Number</label>
                            <input type="text" formControlName="house_number" class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
                            <input type="text" formControlName="state" class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Country</label>
                            <input type="text" formControlName="country" class="input-field">
                        </div>
                    </div>
                </div>

                <!-- Separator -->
                <hr class="border-red-100 my-8">

                <!-- Emergency Contacts Section -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Emergency Contacts *</h3>
                        <button type="button" 
                            (click)="addEmergencyContact()" 
                            [disabled]="emergencyContactsFormArray.length >= 2"
                            class="btn btn-secondary text-sm">
                            <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Add Contact
                        </button>
                    </div>

                    <div class="space-y-4">
                        <div *ngFor="let contact of emergencyContactControls; let i = index" 
                            [formGroup]="contact" 
                            class="card bg-gray-50">
                            <div class="flex justify-between items-start mb-4">
                                <h4 class="font-medium text-gray-900">Emergency Contact {{ i + 1 }}</h4>
                                <button type="button" (click)="removeEmergencyContact(i)" class="text-red-600 hover:text-red-800">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                                    <input type="text" formControlName="first_name" class="input-field">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                                    <input type="text" formControlName="last_name" class="input-field">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Sex</label>
                                    <select formControlName="sex" class="input-field">
                                        <option value="">Select...</option>
                                        <option *ngFor="let option of sexOptions" [value]="option.value">{{ option.label }}</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                                    <input type="tel" formControlName="phone" class="input-field">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                                    <textarea formControlName="address" rows="2" class="input-field"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
                                    <input type="text" formControlName="state" class="input-field">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Country</label>
                                    <input type="text" formControlName="country" class="input-field">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Relationship</label>
                                    <input type="text" formControlName="relationship" placeholder="e.g., Spouse, Parent" class="input-field">
                                </div>
                                <div class="flex items-center">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" formControlName="is_primary" class="mr-2">
                                        <span class="text-sm text-gray-700">Primary Contact</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p *ngIf="emergencyContactsFormArray.length === 0" class="text-red-500 text-sm mt-2">
                        At least one emergency contact is required
                    </p>
                </div>

                <!-- Separator -->
                <hr class="border-red-100 my-8">

                <!-- Management Section -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4 text-gray-900">Management Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                            <input type="text" formControlName="title" class="input-field"
                                [class.border-red-500]="staffForm.get('title')?.invalid && staffForm.get('title')?.touched">
                            <p *ngIf="staffForm.get('title')?.invalid && staffForm.get('title')?.touched" 
                                class="text-red-500 text-xs mt-1">Title is required</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Hire Date *</label>
                            <input type="date" formControlName="hire_date" class="input-field"
                                [disabled]="!canEditHireDate"
                                [class.border-red-500]="staffForm.get('hire_date')?.invalid && staffForm.get('hire_date')?.touched">
                            <p *ngIf="staffForm.get('hire_date')?.invalid && staffForm.get('hire_date')?.touched" 
                                class="text-red-500 text-xs mt-1">Hire date is required</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Salary</label>
                            <input type="number" step="0.01" formControlName="salary" class="input-field" placeholder="Monthly salary">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Shop Assignment</label>
                            <select formControlName="shop_id" class="input-field">
                                <option value="">No Shop Assigned</option>
                                <option *ngFor="let shop of shops" [value]="shop.id">{{ shop.name }}</option>
                            </select>
                        </div>
                        <div *ngIf="canEditIsManager" class="flex items-center">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" formControlName="is_manager" class="mr-2">
                                <span class="text-sm text-gray-700">Is Manager</span>
                            </label>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Performance Tab Content -->
        <div *ngIf="activeTab === 'performance' && !isNew" class="p-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Year</label>
                <select [(ngModel)]="performanceYear" (change)="onPerformanceYearChange()" class="input-field w-48">
                    <option *ngFor="let year of [performanceYear - 2, performanceYear - 1, performanceYear, performanceYear + 1]" 
                        [value]="year">{{ year }}</option>
                </select>
            </div>

            <div *ngIf="performanceData" class="space-y-4">
                <div class="card bg-primary-50">
                    <p class="text-sm text-gray-600">Total Services Completed</p>
                    <p class="text-3xl font-bold text-primary-600">{{ performanceData.total_services }}</p>
                </div>

                <div class="card">
                    <h4 class="text-lg font-semibold mb-4">Monthly Breakdown</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Month</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Services Completed</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <tr *ngFor="let month of performanceData.monthly_breakdown" class="hover:bg-gray-50">
                                    <td class="px-4 py-3 text-sm font-medium text-gray-900">{{ month.month_name }}</td>
                                    <td class="px-4 py-3 text-sm text-right text-gray-900">{{ month.services_completed }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-end gap-3">
        <button class="btn btn-secondary" (click)="onCancel()" [disabled]="saving">
            <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Cancel
        </button>
        <button class="btn btn-primary" (click)="onSave()" [disabled]="saving || staffForm.invalid">
            <svg *ngIf="!saving" class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <svg *ngIf="saving" class="animate-spin w-5 h-5 mr-2 inline" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            {{ saving ? 'Saving...' : 'Save' }}
        </button>
    </div>
</div>

<!-- Loading State -->
<div *ngIf="isLoading" class="card">
    <div class="flex items-center justify-center py-12">
        <svg class="animate-spin h-8 w-8 text-primary-600" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>
</div>

<!-- Confirmation Modals -->
<app-confirmation-modal 
    [isOpen]="showSaveConfirmation" 
    title="Save Changes?"
    message="Are you sure you want to save these staff details?"
    confirmText="Save"
    cancelText="Cancel"
    confirmClass="btn-primary"
    icon="info"
    (confirmed)="confirmSave()"
    (cancelled)="discardSave()">
</app-confirmation-modal>

<app-confirmation-modal 
    [isOpen]="showCancelConfirmation" 
    title="Discard Changes?"
    message="You have unsaved changes. Are you sure you want to discard all changes?"
    confirmText="Discard"
    cancelText="Keep Editing"
    confirmClass="btn-danger"
    icon="warning"
    (confirmed)="confirmCancel()"
    (cancelled)="keepEditing()">
</app-confirmation-modal>
